on:
  push:
    tags:
      - '*'

name: Build Godot Project

env:
  GODOT_VERSION: 4.4.1
  EXPORT_NAME: WorldWriters
  PROJECT_PATH: .

jobs:
  Godot:
    name: Build
    runs-on: ubuntu-24.04  
    strategy:
      matrix:
        platform: [Linux Server, Linux Client, Windows Client,macOS Client]
    container:
      image: barichello/godot-ci:4.4.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mkdir -v -p ~/.config/
          mv /root/.config/godot ~/.config/godot
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Set export filename
        shell: bash
        run: |
          case "${{ matrix.platform }}" in
            "macOS Client")
              echo "EXPORT_FILE=${EXPORT_NAME}.app" >> $GITHUB_ENV
              ;;
            "Windows Client")
              echo "EXPORT_FILE=${EXPORT_NAME}.exe" >> $GITHUB_ENV
              ;;
            *)
              echo "EXPORT_FILE=${EXPORT_NAME}" >> $GITHUB_ENV
              ;;
          esac
      - name: Write server_config.json
        run: |
          cat << 'EOF' > server_config.json
          ${{ secrets.SERVER_CONFIG_JSON }}
          EOF
      - name: ${{ matrix.platform }} Build
        run: |
          mkdir -v -p "build/${{ matrix.platform }}"
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "${{ matrix.platform }}" "$EXPORT_DIR/${{ matrix.platform }}/$EXPORT_FILE"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        env:
          EXPORT_FILE: ${{ env.EXPORT_FILE }}
        with:
          name: ${{ matrix.platform }}
          path: build/${{ matrix.platform }}/${{ env.EXPORT_FILE }}
  
  create-release:
    name: Create Release
    needs: Godot
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get tag name
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Tag: $TAG"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release-files
          TAG="${{ steps.tag.outputs.TAG }}"
          
          # Linux Client
          if [ -d "artifacts/Linux Client" ]; then
            cp -r "artifacts/Linux Client/${EXPORT_NAME}" "release-files/NorthernNights${TAG}"
            chmod +x "release-files/NorthernNights${TAG}"
          fi
          
          # Linux Server
          if [ -d "artifacts/Linux Server" ]; then
            cp -r "artifacts/Linux Server/${EXPORT_NAME}" "release-files/NorthernNightsServer${TAG}"
            chmod +x "release-files/NorthernNightsServer${TAG}"
          fi
          
          # Windows Client
          if [ -d "artifacts/Windows Client" ]; then
            cp -r "artifacts/Windows Client/${EXPORT_NAME}.exe" "release-files/NorthernNights${TAG}.exe"
          fi
          
          # macOS Client - .app Ã¨ una cartella, quindi va zippata
          if [ -d "artifacts/macOS Client" ]; then
            mkdir -p "temp-macos/NorthernNights${TAG}.app"
            cp -r "artifacts/macOS Client/"* "temp-macos/NorthernNights${TAG}.app/"
            cd temp-macos
            zip -r "../release-files/NorthernNights${TAG}.app.zip" "NorthernNights${TAG}.app"
            cd ..
            rm -rf temp-macos
            echo "macOS app zipped successfully"
          fi
          
          ls -lh release-files/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.TAG }}
          name: Release ${{ steps.tag.outputs.TAG }}
          body: |
            ## WorldWriters Build - ${{ steps.tag.outputs.TAG }}
            
            Automated build from commit ${{ github.sha }}
            
            ### Downloads
            - **Linux Client**: `NorthernNights${{ steps.tag.outputs.TAG }}`
            - **Linux Server**: `NorthernNightsServer${{ steps.tag.outputs.TAG }}`
            - **Windows Client**: `NorthernNights${{ steps.tag.outputs.TAG }}.exe`
            - **macOS Client**: `NorthernNights${{ steps.tag.outputs.TAG }}.app.zip` (extract after download)
            
            ### Installation
            1. Download the appropriate file for your platform
            2. For macOS: Extract the .zip file and run the .app bundle
            3. For other platforms: Run the executable directly
            
            
          draft: false
          prerelease: false
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
