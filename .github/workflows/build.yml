on:
  push:
    branches:
      - master

name: Build Godot Project

env:
  GODOT_VERSION: 4.4.1
  EXPORT_NAME: WorldWriters
  PROJECT_PATH: .

jobs:
  Godot:
    name: Build
    runs-on: ubuntu-24.04  
    strategy:
      matrix:
        platform: [Linux Server, Linux Client, Windows Client,macOS Client]
    container:
      image: barichello/godot-ci:4.4.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mkdir -v -p ~/.config/
          mv /root/.config/godot ~/.config/godot
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Set export filename
        shell: bash
        run: |
          case "${{ matrix.platform }}" in
            "macOS Client")
              echo "EXPORT_FILE=${EXPORT_NAME}.app" >> $GITHUB_ENV
              ;;
            "Windows Client")
              echo "EXPORT_FILE=${EXPORT_NAME}.exe" >> $GITHUB_ENV
              ;;
            *)
              echo "EXPORT_FILE=${EXPORT_NAME}" >> $GITHUB_ENV
              ;;
          esac
      - name: Write server_config.json
        run: |
          cat << 'EOF' > server_config.json
          ${{ secrets.SERVER_CONFIG_JSON }}
          EOF
      - name: ${{ matrix.platform }} Build
        run: |
          mkdir -v -p "build/${{ matrix.platform }}"
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "${{ matrix.platform }}" "$EXPORT_DIR/${{ matrix.platform }}/$EXPORT_FILE"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        env:
          EXPORT_FILE: ${{ env.EXPORT_FILE }}
        with:
          name: ${{ matrix.platform }}
          path: build/${{ matrix.platform }}/${{ env.EXPORT_FILE }}
  
  create-release:
    name: Create Release
    needs: Godot
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate version tag
        id: version
        run: |
          VERSION="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release-files
          
          # Linux Server
          if [ -d "artifacts/Linux Server" ]; then
            cp -r "artifacts/Linux Server/${EXPORT_NAME}" "release-files/${EXPORT_NAME}-linux-server"
            chmod +x "release-files/${EXPORT_NAME}-linux-server"
          fi
          
          # Linux Client
          if [ -d "artifacts/Linux Client" ]; then
            cp -r "artifacts/Linux Client/${EXPORT_NAME}" "release-files/${EXPORT_NAME}-linux-client"
            chmod +x "release-files/${EXPORT_NAME}-linux-client"
          fi
          
          # Windows Client
          if [ -d "artifacts/Windows Client" ]; then
            cp -r "artifacts/Windows Client/${EXPORT_NAME}.exe" "release-files/${EXPORT_NAME}-windows-client.exe"
          fi
          
          # macOS Client
          if [ -d "artifacts/macOS Client" ]; then
            cp -r "artifacts/macOS Client/${EXPORT_NAME}.app" "release-files/${EXPORT_NAME}-macos-client.app"
          fi
          
          ls -lh release-files/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## WorldWriters Build - ${{ steps.version.outputs.VERSION }}
            
            Automated build from commit ${{ github.sha }}
            
            ### Downloads
            - **Linux Server**: `${{ env.EXPORT_NAME }}-linux-server`
            - **Linux Client**: `${{ env.EXPORT_NAME }}-linux-client`
            - **Windows Client**: `${{ env.EXPORT_NAME }}-windows-client.exe`
            - **macOS Client**: `${{ env.EXPORT_NAME }}-macos-client.app`
            
            ### Installation
            1. Download the appropriate file for your platform
            2. Extract if necessary
            3. Run the executable
            
          draft: false
          prerelease: false
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
